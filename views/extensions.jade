extends layouts/extensions

block content
    include includes/header-nav

    include includes/sidebar

    include includes/style-switcher
    div(id="modal-dialog", style="display: none;")

    #content
        include includes/content-header
        .container-fluid
            .row-fluid
                .span12
                    .widget-box
                        .widget-title
                        .widget-content.nopadding
                            table( id="tblExtensions", class="table table-bordered table-striped table-hover")
                                thead
                                    tr
                                        th Extension
                                        th Name
                                        th Template
                                        th Context
                            div( style="margin: 5px; margin-top: -35px;", align="center", class="buttons_operation")
                                button(id="btnAddExtension", class="btn")
                                    i.icon-plus
                                    &nbsp;Add
                                button(id="btnEditExtension", class="btn dependent", disabled)
                                    i.icon-pencil
                                    &nbsp;Edit
                                button(id="btnDeleteExtension", class="btn dependent", disabled)
                                    i.icon-remove
                                    &nbsp;Delete
    style
        .select2-drop {z-index: 99999;}
        .left {text-align: left;}

    include includes/footer

    script( src="js/select2.min.js")
    script( src="js/jquery.dataTables.js")
    script( src="js/custom/dataTableExt.js")

    style
        .table-hover tbody > tr:hover > td {
            background-color: #c3c3c3;
                color: #fff;
        }
        .table-hover tbody > tr.row_selected > td {background: #c3c3c3; color: #fff;}

    script

        var currentRow = {};
        //var templateJSON = {};
        var modalId = '#modalWindow';

        // получение темплейтов
        /**/

        var columns = [{"mData": "ext"}, { "mData": "name"}, {"mData": "template"}, {"mData": "context"}, {"mData": "extid"}];
        var columnsDefs = [{"bSearchable": false, "bVisible": false, "aTargets": [4]}];
        var oTable = setDataTableTest('tblExtensions', '/data/extensions/list', columns, columnsDefs);

        var btnsAddExtension = [
            {
                text: "Save",
                "class": 'btn',
                click: function() {
                    if($('#form-main').valid()) {
                        var self = this;
                        $.ajax({
                            type: 'POST',
                            url: '/data/extensions/save_ext',
                            data: $(self).find('form:first').serializeArray(),
                            dataType: 'json',
                            async: false,
                            success: function(data) {
                                if(data.success) {
                                    oTable.fnReloadAjax();
                                    $(self).dialog('close');
                                    changeBtnApply(1);
                                } else showDialog('Information', '<p align="center">'+data.message+'</p>', 'auto', 'auto');
                            }
                        });
                    }
                }
            }
        ];

        $('#tblExtensions tr').live('dblclick', function() {
            showDialog('Edit Extension', {url:'/modal/extension/edit'}, '800', 'auto', btnsAddExtension);
        });

        $('#btnAddExtension').click(function() {
            showDialog('Add Extension', {url:'/modal/extension/add'}, '800', 'auto', btnsAddExtension);
        });

        $('#btnEditExtension').click(function() {
            showDialog('Edit Extension', {url:'/modal/extension/edit'}, '800', 'auto', btnsAddExtension);
        });

        $('#btnDeleteExtension').click(function() {
            var btnsDelete =
                [
                    {
                        text: 'Ok',
                        "class": 'btn btn-primary',
                        click: function() {
                            $(this).dialog('close');
                            $.ajax({
                                type: 'POST',
                                data: {id: currentRow.extid, ext: currentRow.ext},
                                url: '/data/extensions/delete_ext',
                                dataType: 'json',
                                success: function(data) {
                                    if(data.success) {
                                        oTable.fnReloadAjax();
                                        $('#btnEditExtension, #btnOnExtension, #btnOffExtension, #btnDeleteExtension').attr('disabled', true);
                                        changeBtnApply(1);
                                    }
                                    showDialog('Extension',data.message,'auto','auto');
                                }
                            });
                        }
                    },
                    {
                        text: 'Cancel',
                        "class": 'btn btn-primary',
                        click: function() {
                            $(this).dialog('close');
                        }
                    }
                ];

            showDialog('Information', '<p align="center">Delete this Extension?</p>', 'auto', 'auto', btnsDelete);
        });
