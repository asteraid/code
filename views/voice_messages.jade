extends layouts/extensions

block content
    include includes/header-nav

    include includes/sidebar

    include includes/style-switcher
    div(id="modal-dialog", style="display: none;")

    #content
        include includes/content-header
        .container-fluid
            .row-fluid
                .span12
                    .widget-box
                        .widget-title
                        .widget-content.nopadding
                            table( id="tblCdr", class="table table-bordered table-striped table-hover")
                                thead
                                    tr
                                            th(width="200px") Date
                                            th Src
                                            th Dst
                                            th(width="100px") Duration
                                            th Host
                                            th(width="150px") Operations
    #player
      <audio type="audio/mp3"></audio>
    include includes/footer

    script( src="/js/jquery.uniform.js")
    script( src="/js/select2.min.js")
    script( src="/js/jquery.dataTables.js")
    script( src="/js/custom/dataTableExt.js")
    script( src="/js/mediaelement/build/mediaelement-and-player.min.js")
    <link rel="stylesheet" href="/js/mediaelement/build/mediaelementplayer.css" />

    style
        .table-hover tbody > tr:hover > td {
            background-color: #c3c3c3;
                color: #fff;
        }
        .table-hover tbody > tr.row_selected > td {background: #c3c3c3; color: #fff;}

    script

        var columns = [
          {"mData":"start"},
          {"mData":"src"},
          {"mData":"dst"},
          {"mData":"duration"},
          {"mData":"host"},
          {"mData":'voice_message',
           "mRender": function (oObj,type,row) {
              var filename = row.voice_message;
              var host = row.host;
              var urlFile = '/data/voice_messages/get_voice_file?' + 'filename=' + filename;
              
              var buttonPlay = '<button type="button" onclick="play_voice(\''+host+'\',\''+filename+'\')" class="btn btn-small" href="#" data-toggle="tooltip" title="listen file"><i class="icon-headphones"></i></button>';
              
              var buttonLoad = '<a href="' + urlFile + '" class="btn btn-small" href="#" data-toggle="tooltip" title="download file" ><i class="icon-download-alt"></i></a>';
              
              var buttonDelete = ['<a href="', filename, '" class="btn btn-small" onclick="deleteFile(filename); return false;" data-toggle="tooltip" title="delete file">', '<i class="icon-remove"></i>', '</a>'].join('');

              return [buttonPlay, buttonLoad, buttonDelete].join(' ');
            }
          }
        ];

        var columnsDefs = [];

        var currentRow;
        
        var oTable = setDataTableTest('tblCdr', '/data/voice_messages/list', columns, columnsDefs, undefined, undefined, true, true);
        
        function deleteFile(filename) {
          var btnsDelete = [
            {
                text: 'Ok',
                "class": 'btn btn-primary',
                click: function() {
                    $(this).dialog('close');
                    $.ajax({
                        type: 'GET',
                        data: {filename: filename},
                        url: '/data/voice_messages/delete',
                        dataType: 'json',
                        success: function(data) {
                            if(data.success) {
                                oTable.fnReloadAjax();
                            }
                        }
                    });
                }
            },
            {
                text: 'Cancel',
                "class": 'btn btn-primary',
                click: function() {
                    $(this).dialog('close');
                }
            }
          ];
          showDialog('Warning!', '<p align="center">Delete this file?</p>', 'auto', 'auto', btnsDelete);
          //return false;
        });

        function play_voice(host,filename){
            var player;
            var urlFile;
            var title = filename.substring(filename.lastIndexOf('/') + 1);
            // TODO запускаем аяксом скрипт загрузки файла от него получаем имя файла
            if (filename && host) {
                urlFile = '/data/voice_messages/get_voice_file?host=' + host + '&filename=' + filename;
                $('#player').dialog({
                    height: 100, 
                    width: 430,
                    resizable: false, 
                    title: title,
                    close: function(event, ui){
                        if (player){
                            player.pause();
                        }
                    }
                });
                
                $('#player audio').attr('src',urlFile);
                player = new MediaElementPlayer('#player audio');
                player.play();
            }
        }
